# OpenResty Nginx 主配置
# 
# 注意：实际使用时请根据您的环境调整 worker_processes 和 error_log
user  nobody;
worker_processes  auto;

error_log  logs/error.log  info;
pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # --- 1. 定义限流区域 ---
    # limit_req_zone 格式: $binary_remote_addr zone=zone_name:size rate=rate_limit;
    # $binary_remote_addr: 使用客户端IP地址作为限流键
    # zone=mylimit:5m: 定义一个名为 'mylimit' 的共享内存区域，大小为 5MB
    # rate=10r/s: 限制每秒最多 10 个请求
    limit_req_zone  $binary_remote_addr  zone=mylimit:5m  rate=5r/s;

    # --- 2. Upstream 反向代理目标 ---
    # 定义代理的后端服务，即本机 localhost:8080
    upstream backend_service {
        # server 地址设置为本机地址
        server 127.0.0.1:8080; 
        # keepalive 保持与后端服务器的连接，提高性能
        keepalive 32; 
    }

    # --- 3. Server 配置 (监听80端口) ---
    server {
        listen       80;
        # 既然没有域名，可以不设置 server_name，或设置为 localhost
        # server_name  localhost; 

        # 根目录设置（可选，OpenResty主要关注代理/API）
        # location / {
        #     root   html;
        #     index  index.html index.htm;
        # }
        
        # --- 4. OpenResty 核心代理和限流逻辑 ---
        location /api/ {
            # 开启 Nginx 内置的限流模块
            # zone=mylimit: 使用之前定义的限流区域
            # burst=5: 允许突发 5 个请求，超过突发容量的请求将被延迟处理或拒绝 (取决于 nodelay)
            # nodelay: 立即拒绝超过速率限制和突发容量的请求，不进行延迟。
            #          如果移除 nodelay，超过速率限制的请求会延迟到突发容量允许的程度。
            limit_req zone=mylimit burst=5 nodelay; 
            
            # 限制请求处理速率：10r/s
            # limit_req zone=mylimit rate=10r/s; 

            # 当限流触发时返回 503 错误
            error_page 503 @rate_limit_error;

            # ---------------------------
            # 反向代理配置
            # ---------------------------
            
            # 将请求转发到 upstream 定义的后端服务
            proxy_pass http://backend_service/; 

            # 设置请求头，传递客户端真实IP等信息给后端服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 可选：解决代理过程中可能出现的连接、超时问题
            proxy_connect_timeout 60;
            proxy_send_timeout 60;
            proxy_read_timeout 60;
        }

        # --- 5. 错误处理 Location ---
        # 专门处理限流触发后的请求
        location @rate_limit_error {
            # 返回 429 Too Many Requests
            return 429 "Too Many Requests - Rate Limit Exceeded\n";
        }
    }
}